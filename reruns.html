<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Automatic rerun detection &mdash; luisy  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Decorators" href="decorators.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            luisy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="about/about.html">Why?</a></li>
<li class="toctree-l1"><a class="reference internal" href="about/authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="about/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributions.html">Contributions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorials/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/parameters.html">WrapperTasks and ConcatenationTasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/multi_file.html">Directory Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/cloud.html">Up- and Downloading Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/reruns.html">Trigger reruns by changing code</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/spark.html">Interaction with PySpark</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="task.html">Task structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="decorators.html">Decorators</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Reruns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mechanics-of-the-hash-computation">Mechanics of the hash computation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#core-algorithm">Core Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dealing-with-external-requirements">Dealing with external requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#guidelines-when-creating-the-code-of-your-task">Guidelines when creating the code of your task</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualize.html">Visualize</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloud.html">Cloud sync</a></li>
<li class="toctree-l1"><a class="reference internal" href="helpers.html">Helper funcs</a></li>
<li class="toctree-l1"><a class="reference internal" href="hash_update_mode.html">Hash Update Mode</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">Full reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Legal</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="legal/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="legal/corporate_information.html">Corporate information</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">luisy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Automatic rerun detection</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/reruns.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="automatic-rerun-detection">
<h1>Automatic rerun detection<a class="headerlink" href="#automatic-rerun-detection" title="Permalink to this heading"></a></h1>
<section id="overview">
<span id="rerun"></span><h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>Depending on how many people are working on the same pipeline, manual
deletions can get annoying quite fast.  Therefore a feature is implemented
in <a class="reference internal" href="api/luisy.tasks.html#luisy.tasks.base.Task" title="luisy.tasks.base.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">luisy.tasks.base.Task</span></code></a> to detect whether the task needs to be rerun based on code
changes.</p>
<p>More specific, whenever a <a class="reference internal" href="api/luisy.html#module-luisy" title="luisy"><code class="xref py py-mod docutils literal notranslate"><span class="pre">luisy</span></code></a> pipeline has been successfully
executed, a hash of the code of all executed tasks is computed and
stored into a <code class="code docutils literal notranslate"><span class="pre">.luisy.hash</span></code> file located in the project directory
and whenever a <a class="reference internal" href="api/luisy.html#module-luisy" title="luisy"><code class="xref py py-mod docutils literal notranslate"><span class="pre">luisy</span></code></a> pipeline is executed, the hashes of the
tasks computed at runtime are compared with the persisted hashes.
If code of a task changes then its hash changes, the task is executed
again, and its outfile is overwritten. Moreover, all the downstream
dependencies of this task are re-run as well as their input may have
changed.</p>
<p>Long story short: <strong>You will never have to manually delete files anymore</strong></p>
</section>
<section id="mechanics-of-the-hash-computation">
<h2>Mechanics of the hash computation<a class="headerlink" href="#mechanics-of-the-hash-computation" title="Permalink to this heading"></a></h2>
<p>The first idea is to create a hash value out of the sourcecode of every task.
However it is not enough to only capture the code of the task itself, we also need to capture:</p>
<ul class="simple">
<li><p>the sourcecode of functions, classes and constants used in the source code of the task</p></li>
<li><p>versions of external libraries used</p></li>
</ul>
<section id="core-algorithm">
<h3>Core Algorithm<a class="headerlink" href="#core-algorithm" title="Permalink to this heading"></a></h3>
<p>Using pythons AST library, we analyse the source code inside the body of the task class.
With AST, we can get all variable names, that are used inside the class body.
We also obtain all the local variables which are assigned (stored) inside the class body.
This way we can identify variable names that are</p>
<ul class="simple">
<li><p>used inside the class body</p></li>
<li><p>not defined/assigned inside the class body</p></li>
</ul>
<p>These variables must be coming from outside the class body.
Now we can check which of these three cases applies:</p>
<ul class="simple">
<li><p>Import from an external library</p></li>
<li><p>Import from another module of the same package as our task is in</p></li>
<li><p>Variable is a function, class or constant from the same module as our task is in</p></li>
</ul>
<p>For the last two cases, we can just apply the same step recursively and add the sourcecode to a list.
Whenever we hit external dependencies, we collect their version info from the <code class="code docutils literal notranslate"><span class="pre">requirements.txt</span></code>
and add it to a list. If we cannot find a <cite>requirements.txt</cite>, we use
<code class="xref py py-mod docutils literal notranslate"><span class="pre">pipdeptree</span></code> to infer the version of the dependency from the installation.
When the recursive algorithm has stopped, we generate a hash of all the source code and version
info that we have collected.</p>
</section>
<section id="dealing-with-external-requirements">
<h3>Dealing with external requirements<a class="headerlink" href="#dealing-with-external-requirements" title="Permalink to this heading"></a></h3>
<p>First, find all the external packages that our task uses.
If a package (package A) is not listed in <cite>requirements.txt</cite> directly, we look for  another
package (package B) that requires package A and is itself listed in <cite>requirements.txt</cite>. Then we
can include the version info of package B in the hash.</p>
</section>
<section id="guidelines-when-creating-the-code-of-your-task">
<h3>Guidelines when creating the code of your task<a class="headerlink" href="#guidelines-when-creating-the-code-of-your-task" title="Permalink to this heading"></a></h3>
<p>To use the task hash functionality most efficiently, note the following points:</p>
<ul class="simple">
<li><p>Do not shadow variables from module scope in class- or function scope. If you shadow a module
level variable with a class-or function-level one, changes in the former will not be detected.</p></li>
<li><p>Try to import only what you need, not the whole module. Otherwise a tiny change in the imported
module changes the hash of your task and leads to re-execution.</p></li>
<li><p>Star imports are not supported. They will make the hash creation fail.</p></li>
<li><p>When using <code class="code docutils literal notranslate"><span class="pre">eval</span></code>, the variables used inside the the expression will not be tracked.</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="decorators.html" class="btn btn-neutral float-left" title="Decorators" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="testing.html" class="btn btn-neutral float-right" title="Testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021-2022, Robert Bosch GmbH.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>